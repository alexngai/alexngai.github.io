var calculateDistance=function(t,s){return Math.sqrt((x=Math.abs(t.x-s.x))*x+(y=Math.abs(t.y-s.y))*y)},calcMagnitude=function(t,s){return Math.sqrt(t*t+s*s)},calcVectorAdd=function(t,s,e=1){return{x:t.x+s.x*e,y:t.y+s.y*e}},calcVectorSubtract=function(t,s){let e={x:t.x,y:t.y};return e.x-=s.x,e.y-=s.y,e};function calcVectorMult(t,s){return{x:t.x*s,y:t.y*s}}var calcVectorLerp=function(t,s,e=.5){return{x:t.x*(1-e)+s.x*e,y:t.y*(1-e)+s.y*e}},calcVectorNorm=function(t){var s=calcMagnitude(t.x,t.y);return{x:t.x/s,y:t.y/s,mag:1}};function calcOrthogonalVector(t){return calcVectorNorm({x:-1*t.y,y:t.x})}function calcVectorAngle(t){return(2*Math.PI+Math.atan2(t.y,t.x))%2*Math.PI}var random=function(t,s){return t+Math.random()*(s-t)},getRandomItem=function(t,s){for(var e=random(0,s.reduce(function(t,s,e,h){return t+s})),h=0,n=0;n<t.length;n++)if(h+=s[n],e<=(h=+h.toFixed(2)))return t[n]};function Boid(t,s,e){this.init(t,s,e)}const OSCILLATION_PERIOD=50,OSCILLATION_AMPLITUDE=3,MARGIN_BUFFER=100,BOID_SEGMENTS=[.2,.5,.8,.9,.7,.5,.3,.1];function Predator(t,s){this.init(t,s),this.type="predator",this.maturity=6,this.speed=2,this.size=~~random(7,9),this.hungerLimit=25e3;let e=~~random(130,170),h=~~random(160,200),n=~~random(200,225);this.angMomentum=.07,this.color="rgb("+e+","+h+","+n+")",this.finColor="rgb("+(e-10)+","+(h-10)+","+(n-10)+")",this.oscillationPeriod=50*this.size*.85,this.oscillationAmplitude=3*this.size*1.2,this.segmentSize=[.3,.5,.7,.9,.93,.96,1,.85,.8,.75,.64,.53,.5,.4,.22,.15,.18,.13,.1,.08],this.sizeMult=1.5,this.eyesight=200,this.flockDistance=2e3,this.matchVelFactor=2e3,this.separationScale=1,this.personalSpace=70,this.initSegments()}function drawFin(t,s,e,h,n,o){let a=[.25,.35,.6,.85,.95,1];s.beginPath(),s.moveTo(t.segments[e].x,t.segments[e].y);var r=calcVectorSubtract(t.segments[e],t.segments[e-1]);let l=calcOrthogonalVector(r);l=o?l:calcVectorMult(l,-1);var $=calcVectorMult(calcVectorNorm(r),t.size*n);for(let m=0;m<a.length;m++){let d=calcVectorMult(l,a[m]*t.size*h),g=calcVectorAdd(calcVectorAdd(t.segments[e],calcVectorMult($,m)),d);s.lineTo(g.x,g.y)}let u=calcVectorMult(l,.35*t.size*h),_=calcVectorAdd(calcVectorAdd(t.segments[e],calcVectorMult($,a.length-2)),u);s.lineTo(_.x,_.y),s.lineTo(t.segments[e].x,t.segments[e].y),s.fillStyle=t.finColor,s.shadowBlur=2,s.shadowColor=t.color,s.fill()}Boid.prototype={init:function(t,s){this.type="boid",this.health=1,this.maturity=4,this.speed=1.6,this.size=5*~~random(70,100)/100,this.hungerLimit=12e3,this.hunger=0,this.isFull=!1,this.digestTime=400,this.color="rgb("+~~random(0,100)+","+~~random(50,220)+","+~~random(50,220)+")",this.segmentSize=BOID_SEGMENTS,this.sizeMult=1,this.oscillationPeriod=~~random(80,120)/100*50*this.size/3,this.oscillationAmplitude=~~random(80,120)/100*3*this.size/5,this.eyesight=100,this.personalSpace=15,this.flightDistance=60,this.flockDistance=1e3,this.matchVelFactor=4,this.momentum=.25,this.angMomentum=.1,this.separationScale=.2,this.maxAccel=1,this.x=t||0,this.y=s||0,this.v={x:random(-1,1),y:random(-1,1),mag:0},this.acc={x:0,y:0},this.heading=this.v,this.unitV={x:0,y:0},this.v.mag=calcMagnitude(this.v.x,this.v.y),this.unitV.x=this.heading.x/this.heading.mag,this.unitV.y=this.heading.y/this.heading.mag,this.phase=2*Math.random()*Math.PI,this.initSegments()},initSegments:function(){this.segments=[{x:this.x,y:this.y}];let t=calcVectorAngle(this.heading);for(var s=1;s<this.segmentSize.length;s++)this.segments.push({x:this.segments[s-1].x+this.size*Math.cos(t),y:this.segments[s-1].y+this.size*Math.sin(t)})},ai:function(t,s,e,h){perceivedCenter={x:0,y:0,count:0},perceivedVelocity={x:0,y:0,count:0},mousePredator={x:void 0===e.touches[0]?0:e.touches[0].x,y:void 0===e.touches[0]?0:e.touches[0].y};for(var n=0;n<t.length;n++)n!=s&&(dist=calculateDistance(this,t[n]))<this.eyesight&&(t[n].type==this.type?(perceivedCenter.x+=t[n].x,perceivedCenter.y+=t[n].y,perceivedCenter.count++,perceivedVelocity.x+=t[n].v.x,perceivedVelocity.y+=t[n].v.y,perceivedVelocity.count++,dist<this.personalSpace+this.size&&this.avoidOrAttract("avoid",t[n],this.separationScale)):this.handleOther(t[n]));perceivedCenter.count>0&&(perceivedCenter.x=(perceivedCenter.x/perceivedCenter.count-this.x)/this.flockDistance,perceivedCenter.y=(perceivedCenter.y/perceivedCenter.count-this.y)/this.flockDistance),perceivedVelocity.count>0&&(perceivedVelocity.x=(perceivedVelocity.x/perceivedVelocity.count-this.v.x)/this.matchVelFactor,perceivedVelocity.y=(perceivedVelocity.y/perceivedVelocity.count-this.v.y)/this.matchVelFactor),this.acc=calcVectorAdd(this.acc,calcVectorAdd(perceivedCenter,perceivedVelocity),1-this.momentum),calculateDistance(mousePredator,this)<this.eyesight&&this.avoidOrAttract("avoid",mousePredator,20),this.limitAcceleration(),this.v={x:this.v.x+this.acc.x*h/(.001*this.size),y:this.v.x+this.acc.y*h/(.001*this.size)},this.limitVelocity()},setUnitVector:function(){var t=calcMagnitude(this.v.x,this.v.y);this.v.x=this.v.x/t,this.v.y=this.v.y/t},limitVelocity:function(){this.v.mag=calcMagnitude(this.v.x,this.v.y),this.unitV.x=this.v.x/this.v.mag,this.unitV.y=this.v.y/this.v.mag,this.v.mag>this.speed&&(this.v.x=this.unitV.x*this.speed,this.v.y=this.unitV.y*this.speed)},limitAcceleration:function(){calcMagnitude(this.acc.x,this.acc.y)>this.maxAccel&&(this.acc=calcVectorMult(calcVectorNorm(this.acc),this.maxAccel))},avoidOrAttract:function(t,s,e){var h={x:0,y:0},n="avoid"===t?-1:1,o=calculateDistance(this,s),a=(e||1)*((this.eyesight-o)/this.eyesight);h.x+=(s.x-this.x)*a*n,h.y+=(s.y-this.y)*a*n,this.acc=calcVectorAdd(this.acc,h,1-this.momentum)},move:function(t,s){this.heading=calcVectorLerp(this.heading,calcVectorNorm(this.v),this.angMomentum),this.heading=calcVectorNorm(this.heading);var e=calcMagnitude(this.v.x,this.v.y);this.x+=this.heading.x*e,this.y+=this.heading.y*e,this.x>t.width+100?(this.x=this.x-t.width-200,this.shiftSegments()):this.x<-100&&(this.x=this.x+t.width+200,this.shiftSegments()),this.y>t.height+100?(this.y=this.y-t.height-200,this.shiftSegments()):this.y<-100&&(this.y=this.y+t.height+200,this.shiftSegments()),this.v.mag>this.speed?this.hunger+=this.speed:this.hunger+=this.v.mag,this.updateSegments(s)},eat:function(t){this.isFull||"plant"!==t.type||(t.health--,this.health++,this.isFull=!0,this.hunger=0)},handleOther:function(t){"predator"===t.type&&this.avoidOrAttract("avoid",t)},draw:function(t){drawSize=this.size,t.beginPath(),t.moveTo(this.segments[0].x,this.segments[0].y);for(let s=1;s<this.segmentSize.length;s++){var e=calcVectorSubtract(this.segments[s-1],this.segments[s]);let h=calcVectorMult(calcOrthogonalVector(e),this.segmentSize[s]*this.size*this.sizeMult),n=calcVectorAdd(this.segments[s],h);t.lineTo(n.x,n.y)}for(let o=this.segmentSize.length-1;o>0;o--){var e=calcVectorSubtract(this.segments[o],this.segments[o-1]);let a=calcVectorMult(calcOrthogonalVector(e),this.segmentSize[o]*this.size*this.sizeMult),r=calcVectorAdd(this.segments[o],a);t.lineTo(r.x,r.y)}t.lineTo(this.segments[0].x,this.segments[0].y),t.fillStyle=this.color,t.shadowBlur=2,t.shadowColor=this.color,t.fill()},updateSegments:function(t){let s=this.segments[0];this.segments[0]={x:this.x,y:this.y};let e=this.segmentSize.length/2*Math.PI,h=calcMagnitude(this.v.x,this.v.y)/this.speed,n=Math.sin(Date.now()/this.oscillationPeriod+this.phase)*this.oscillationAmplitude*h,o=calcOrthogonalVector(this.v);o=calcVectorMult(o,n),this.segments[0]=calcVectorAdd({x:this.x,y:this.y},o);let a={x:this.segments[0].x-s.x,y:this.segments[0].y-s.y};calcMagnitude(a.x,a.y)>2&&(a=calcVectorMult(calcVectorNorm(a),2),this.segments[0]={x:s.x+a.x,y:s.y+a.y});for(let r=1;r<this.segmentSize.length;r++){var l=calcVectorSubtract(this.segments[r-1],this.segments[r]);let $=calcOrthogonalVector(l);l=calcVectorAdd(l,calcVectorMult($,Math.sin(Date.now()/this.oscillationPeriod+r*e+this.phase)*h*1.25*r/this.segmentSize.length)),l=calcVectorMult(calcVectorNorm(l),this.size),this.segments[r]=calcVectorSubtract(this.segments[r-1],l)}},shiftSegments:function(){let t=this.x-this.segments[0].x,s=this.y-this.segments[0].y;for(let e=0;e<this.segments.length;e++)this.segments[e].x+=t,this.segments[e].y+=s}},Predator.prototype=new Boid,Predator.prototype.constructor=Predator,Predator.constructor=Boid.prototype.constructor,Predator.prototype.eat=function(t){this.isFull||"boid"!==t.type||(t.health--,this.health++,this.isFull=!0,this.hunger=0)},Predator.prototype.handleOther=function(t){"boid"!==t.type||this.isFull||this.avoidOrAttract("attract",t)},Predator.prototype.draw=function(t){drawSize=this.size,drawFin(this,t,4,4,.75,!0),drawFin(this,t,4,4,.75,!1),drawFin(this,t,9,1.5,.3,!0),drawFin(this,t,9,1.5,.3,!1),drawFin(this,t,16,.5,.5,!1),t.beginPath(),t.moveTo(this.segments[0].x,this.segments[0].y);for(let s=1;s<this.segmentSize.length;s++){var e=calcVectorSubtract(this.segments[s-1],this.segments[s]);let h=calcVectorMult(calcOrthogonalVector(e),this.segmentSize[s]*this.size*1.5),n=calcVectorAdd(this.segments[s],h);t.lineTo(n.x,n.y)}for(let o=this.segmentSize.length-1;o>0;o--){var e=calcVectorSubtract(this.segments[o],this.segments[o-1]);let a=calcVectorMult(calcOrthogonalVector(e),this.segmentSize[o]*this.size*1.5),r=calcVectorAdd(this.segments[o],a);t.lineTo(r.x,r.y)}t.lineTo(this.segments[0].x,this.segments[0].y),t.fillStyle=this.color,t.shadowBlur=2,t.shadowColor=this.color,t.fill(),drawFin(this,t,7,1,.4,!0)};var boids=[],sim=Sketch.create({container:document.getElementById("container")});sim.setup=function(){for(i=0;i<80;i++)x=random(0,sim.width),y=random(0,sim.height),sim.spawn(x,y);sim.spawn(random(0,sim.width),random(0,sim.height),"predator"),sim.spawn(random(0,sim.width),random(0,sim.height),"predator")},sim.spawn=function(t,s,e){e||(e=getRandomItem(["boid","predator"],[.995,.005])),boid="predator"===e?new Predator(t,s):new Boid(t,s),boids.push(boid)};var then=Date.now()/1e3;sim.update=function(){let t=Date.now()/1e3-then;for(i=boids.length-1;i>=0;i--)boids[i].ai(boids,i,sim,t),boids[i].move(sim,t)};var c=0,fps=0;sim.draw=function(){for(i=boids.length-1;i>=0;i--)boids[i].draw(sim);var t=Date.now()/1e3;c%50==0&&(fps=1/(t-then),c=0),then=t,sim.fillStyle="rgb(100,100,100)",sim.shadowBlur=0,sim.fillText("fps: "+fps.toFixed(2),sim.width-50,sim.height-10),c++};